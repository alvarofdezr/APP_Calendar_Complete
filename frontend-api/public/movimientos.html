<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Movimientos</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    .table-responsive {
      max-width: 100%;
      overflow-x: auto;
    }
    /* Ocultar el campo de texto "Otra" por defecto */
    #campo-categoria-otra {
        display: none;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow">
      <div class="card-body p-4 p-md-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
          <a href="dashboard.html" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> Volver al Dashboard
          </a>
          <h2 class="mb-0 text-center flex-grow-1" style="margin-right: 150px;">A√±adir Movimiento</h2>
        </div>
        <hr>

        <form id="form-mensaje" autocomplete="off">
          
          <div class="row mb-3">
            <div class="col-md-6 mb-2 mb-md-0">
              <label for="tipo" class="form-label">Tipo de Movimiento</label>
              <select id="tipo" class="form-select" required>
                <option value="gasto" selected>Gasto</option>
                <option value="ingreso">Ingreso</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="cantidad" class="form-label">Cantidad (‚Ç¨)</label>
              <input type="number" id="cantidad" class="form-control" placeholder="Ej: 12.50" min="0.01" step="0.01" required autocomplete="off">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6 mb-2 mb-md-0">
              <label for="categoria" class="form-label">Categor√≠a</label>
              <select id="categoria" class="form-select" required>
                <option value="" disabled selected>-- Elige una categor√≠a --</option>
                <optgroup label="Gastos Comunes">
                  <option value="Comida">üçî Comida</option>
                  <option value="Transporte">üöó Transporte</option>
                  <option value="Vivienda">üè† Vivienda</option>
                  <option value="Ocio">üéâ Ocio</option>
                  <option value="Facturas">üí° Facturas</option>
                  <option value="Ropa">üëï Ropa</option>
                  <option value="Salud">‚ù§Ô∏è Salud</option>
                </optgroup>
                <optgroup label="Ingresos">
                  <option value="N√≥mina">üíº N√≥mina</option>
                  <option value="Regalo">üéÅ Regalo</option>
                  <option value="Ventas">üìà Ventas</option>
                </optgroup>
                <optgroup label="Otros">
                   <option value="Otra">‚úèÔ∏è Otra (Especificar)</option>
                </optgroup>
              </select>
            </div>
            
            <div class="col-md-6" id="campo-categoria-otra">
                <label for="categoria-otra" class="form-label">Especifica la categor√≠a</label>
                <input type="text" id="categoria-otra" class="form-control" placeholder="Ej: Supermercado" autocomplete="off">
            </div>
          </div>
          <div class="row mb-3">
              <div class="col-md-12">
                  <label for="descripcion" class="form-label">Descripci√≥n (Opcional)</label>
                  <input type="text" id="descripcion" class="form-control" placeholder="Ej: Cena con amigos" autocomplete="off">
              </div>
          </div>

          <div class="d-flex justify-content-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> Guardar Movimiento
            </button>
          </div>
        </form>

        <div class="mt-4">
          <h5>Estado del env√≠o:</h5>
          <pre id="respuesta" class="bg-white p-3 border rounded"></pre>
        </div>

        <hr class="my-4">

        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">√öltimos Movimientos</h5>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th scope="col">Fecha</th>
                    <th scope="col">Tipo</th>
                    <th scope="col">Categor√≠a</th>
                    <th scope="col">Descripci√≥n</th>
                    <th scope="col" class="text-end">Cantidad</th>
                  </tr>
                </thead>
                <tbody id="historial-body">
                  <tr><td colspan="5" class="text-center">Cargando...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- Funci√≥n para decodificar el token ---
    function parseJwt(token) {
        try {
            return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
            return null;
        }
    }

    const token = localStorage.getItem('token');

    if (!token) {
        window.location.href = 'login.html';
    } else {
        const payload = parseJwt(token);
        if (!payload || !payload.usuario) {
            localStorage.removeItem('token');
            window.location.href = 'login.html';
        }
    }

    // --- ¬°NUEVA L√ìGICA PARA OCULTAR/MOSTRAR "OTRA" CATEGOR√çA! ---
    const selectCategoria = document.getElementById('categoria');
    const campoOtraCategoria = document.getElementById('campo-categoria-otra');

    selectCategoria.addEventListener('change', function() {
        if (this.value === 'Otra') {
            campoOtraCategoria.style.display = 'block'; // Mostrar
            document.getElementById('categoria-otra').required = true;
        } else {
            campoOtraCategoria.style.display = 'none'; // Ocultar
            document.getElementById('categoria-otra').required = false;
        }
    });

    //--- Enviar Movimiento con el token ---
    document.getElementById('form-mensaje').addEventListener('submit', async function(e) {
        e.preventDefault();
        const respuestaEl = document.getElementById('respuesta');

        const tipo = document.getElementById('tipo').value;
        const cantidad = document.getElementById('cantidad').value;
        const descripcion = document.getElementById('descripcion').value.trim();

        // --- ¬°L√ìGICA DE CATEGOR√çA MODIFICADA! ---
        let categoria = selectCategoria.value;
        if (categoria === 'Otra') {
            categoria = document.getElementById('categoria-otra').value.trim();
        }

        if (!tipo || !cantidad || !categoria) {
            respuestaEl.textContent = 'Tipo, Cantidad y Categor√≠a son obligatorios.';
            return;
        }
        if (isNaN(cantidad) || Number(cantidad) <= 0) {
            respuestaEl.textContent = 'La cantidad debe ser un n√∫mero positivo.';
            return;
        }

        const mensajeMovimiento = `${tipo},${cantidad},${categoria},${descripcion}`;
        
        if (mensajeMovimiento.length > 250) { 
          respuestaEl.textContent = 'Error: El registro es demasiado largo (m√°ximo 250 caracteres).';
          return;
        }

        const token = localStorage.getItem('token');
        if (!token) {
            respuestaEl.textContent = 'Sesi√≥n expirada. Redirigiendo al login...';
            setTimeout(() => { window.location.href = 'login.html'; }, 2000);
            return;
        }

        respuestaEl.textContent = 'Enviando al servidor seguro...';

        try {
            const res = await fetch('/api/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ mensaje: mensajeMovimiento })
            });

            const data = await res.json();

            if (res.status === 401 || res.status === 403) {
                respuestaEl.textContent = data.error || 'Sesi√≥n expirada. Por favor, inicie sesi√≥n de nuevo.';
                localStorage.removeItem('token');
                setTimeout(() => { window.location.href = 'login.html'; }, 2000);
            } else {
                let mensajeRespuesta = data.respuesta || data.error || data.mensaje || 'Error desconocido.';
                if (mensajeRespuesta) mensajeRespuesta = mensajeRespuesta.replace(/¬ß/g, '');
                respuestaEl.textContent = mensajeRespuesta;

                if (res.ok && data.respuesta && data.respuesta.startsWith('OK')) {
                    // Resetear formulario
                    document.getElementById('form-mensaje').reset();
                    campoOtraCategoria.style.display = 'none'; // Ocultar campo "otra"
                    selectCategoria.value = ""; // Resetear select
                    cargarHistorial(); // ¬°Recargar la tabla!
                }
            }
        } catch (err) {
            respuestaEl.textContent = 'Error de conexi√≥n con el servidor: ' + err.message;
        }
    });

    // === Cargar Historial al iniciar ===
    async function cargarHistorial() {
      const token = localStorage.getItem('token');
      if (!token) return; 

      const tbody = document.getElementById('historial-body');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center">Cargando...</td></tr>';

      try {
        const res = await fetch('/api/movimientos', {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (!res.ok) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar el historial.</td></tr>';
          return;
        }

        const data = await res.json();
        if (data.exito && data.movimientos && data.movimientos.length > 0) {
          tbody.innerHTML = ''; 
          
          data.movimientos.forEach(mov => {
            const tr = document.createElement('tr');
            const esGasto = mov.tipo === 'gasto';
            const claseCantidad = esGasto ? 'text-danger fw-bold' : 'text-success fw-bold';
            
            const fecha = new Date(mov.fecha).toLocaleString('es-ES', { 
              day: '2-digit', 
              month: '2-digit', 
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });

            tr.innerHTML = `
              <td>${fecha}</td>
              <td><span class="badge ${esGasto ? 'bg-warning text-dark' : 'bg-success'}">${mov.tipo}</span></td>
              <td>${mov.categoria}</td>
              <td>${mov.descripcion || '<em>-</em>'}</td>
              <td class="text-end ${claseCantidad}">${esGasto ? '-' : '+'}${parseFloat(mov.cantidad).toFixed(2)} ‚Ç¨</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay movimientos registrados.</td></tr>';
        }
      } catch (err) {
        console.error('Error en cargarHistorial:', err);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error de conexi√≥n al cargar.</td></tr>';
      }
    }

    document.addEventListener('DOMContentLoaded', cargarHistorial);

  </script>
</body>
</html>