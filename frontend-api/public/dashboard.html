<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Financiero</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .kpi-card { border-left-width: 5px; }
    .kpi-icon { font-size: 2.5rem; opacity: 0.3; }
    /* Altura fija para los contenedores de gráficos de dona */
    .chart-container {
        height: 400px;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">Hola, <span id="nombre-usuario">...</span></h1>
      <button class="btn btn-danger" id="cerrar-sesion">
        <i class="fas fa-sign-out-alt"></i> Salir
      </button>
    </div>

    <div class="row">
      <div class="col-md-4 mb-4">
        <div class="card shadow-sm kpi-card border-primary">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="text-primary text-uppercase fw-bold small">Balance Total</div>
              <div class="h3 fw-bold mb-0" id="kpi-balance">0,00 €</div>
            </div>
            <i class="fas fa-wallet kpi-icon"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card shadow-sm kpi-card border-success">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="text-success text-uppercase fw-bold small">Ingresos Totales</div>
              <div class="h3 fw-bold mb-0" id="kpi-ingresos">+0,00 €</div>
            </div>
            <i class="fas fa-arrow-up kpi-icon"></i>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card shadow-sm kpi-card border-danger">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="text-danger text-uppercase fw-bold small">Gastos Totales</div>
              <div class="h3 fw-bold mb-0" id="kpi-gastos">-0,00 €</div>
            </div>
            <i class="fas fa-arrow-down kpi-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-arrow-down text-danger"></i> Gastos por Categoría</h5>
          </div>
          <div class="card-body chart-container">
            <canvas id="grafico-gastos"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
          <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-arrow-up text-success"></i> Ingresos por Categoría</h5>
          </div>
          <div class="card-body chart-container">
            <canvas id="grafico-ingresos"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Flujo de Dinero (Últimos movimientos)</h5>
                </div>
                <div class="card-body chart-container">
                    <canvas id="grafico-flujo"></canvas>
                </div>
            </div>
        </div>
    </div>


    <div class="row">
        <div class="col-12 text-center d-flex justify-content-center gap-3">
            <a href="movimientos.html" class="btn btn-primary btn-lg">
                <i class="fas fa-plus"></i> Añadir Movimiento
            </a>
            <a href="movimientos.html" id="historial-link" class="btn btn-outline-secondary btn-lg">
                <i class="fas fa-history"></i> Ver Historial Completo
            </a>
        </div>
    </div>

  </div>

  <script>
    // === Variables Globales ===
    const token = localStorage.getItem('token');
    let chartGastos = null;
    let chartIngresos = null; // <-- Nueva variable
    let chartFlujo = null;

    // === Funciones de Ayuda ===
    function parseJwt(token) {
        try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; }
    }
    function formatCurrency(value) {
      return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(value);
    }
    function checkToken() {
      if (!token) { window.location.href = 'login.html'; return false; }
      const payload = parseJwt(token);
      if (!payload || !payload.usuario) {
          localStorage.removeItem('token');
          window.location.href = 'login.html';
          return false;
      }
      document.getElementById('nombre-usuario').textContent = payload.usuario;
      document.getElementById('historial-link').href = 'movimientos.html';
      return true;
    }

    // === Lógica Principal ===
    document.addEventListener('DOMContentLoaded', () => {
      if (!checkToken()) return;
      cargarEstadisticas();
      cargarMovimientosParaGraficos();
      document.getElementById('cerrar-sesion').addEventListener('click', () => {
          localStorage.removeItem('token');
          window.location.href = 'index.html';
      });
    });

    // --- Cargar Tarjetas KPI ---
    async function cargarEstadisticas() {
      try {
        const res = await fetch('/api/estadisticas', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Error al cargar estadísticas');
        const data = await res.json();
        if (data.exito && data.stats) {
          const stats = data.stats;
          document.getElementById('kpi-balance').textContent = formatCurrency(stats.balance_total);
          document.getElementById('kpi-ingresos').textContent = '+' + formatCurrency(stats.total_ingresos);
          document.getElementById('kpi-gastos').textContent = '-' + formatCurrency(stats.total_gastos);
        }
      } catch (err) { console.error(err); }
    }

    // --- Cargar Datos para Gráficos ---
    async function cargarMovimientosParaGraficos() {
      try {
        const res = await fetch('/api/movimientos?limit=50', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Error al cargar movimientos');
        
        const data = await res.json();
        if (data.exito && data.movimientos) {
          // Llamamos a las 3 funciones de gráficos
          crearGraficoGastos(data.movimientos);
          crearGraficoIngresos(data.movimientos); // <-- Nueva llamada
          crearGraficoFlujo(data.movimientos);
        }
      } catch (err) { console.error(err); }
    }

    // --- Gráfico 1: Gastos por Categoría (Dona) ---
    // (Nombre de función cambiado de crearGraficoCategorias a crearGraficoGastos)
    function crearGraficoGastos(movimientos) {
      const gastos = movimientos.filter(m => m.tipo === 'gasto');
      const categorias = {}; 
      gastos.forEach(gasto => {
        const categoria = gasto.categoria || 'Sin Categoría';
        const cantidad = parseFloat(gasto.cantidad);
        if (!categorias[categoria]) { categorias[categoria] = 0; }
        categorias[categoria] += cantidad;
      });

      const labels = Object.keys(categorias);
      const data = Object.values(categorias);

      const ctx = document.getElementById('grafico-gastos').getContext('2d'); // <-- ID cambiado
      if (chartGastos) chartGastos.destroy(); 
      
      chartGastos = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            label: 'Gastos',
            data: data,
            backgroundColor: [ '#FF6384', '#FF9F40', '#FFCE56', '#4BC0C0', '#9966FF', '#C9CBCF' ],
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // <-- Añadido
          plugins: { legend: { position: 'top' } }
        }
      });
    }

    // --- ¡NUEVO GRÁFICO! Ingresos por Categoría (Dona) ---
    function crearGraficoIngresos(movimientos) {
      const ingresos = movimientos.filter(m => m.tipo === 'ingreso');
      const categorias = {}; 
      ingresos.forEach(ingreso => {
        const categoria = ingreso.categoria || 'Sin Categoría';
        const cantidad = parseFloat(ingreso.cantidad);
        if (!categorias[categoria]) { categorias[categoria] = 0; }
        categorias[categoria] += cantidad;
      });

      const labels = Object.keys(categorias);
      const data = Object.values(categorias);

      const ctx = document.getElementById('grafico-ingresos').getContext('2d'); // <-- ID nuevo
      if (chartIngresos) chartIngresos.destroy(); 
      
      chartIngresos = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            label: 'Ingresos',
            data: data,
            backgroundColor: [ '#36A2EB', '#4CAF50', '#00BCD4', '#8BC34A', '#03A9F4', '#76FF03' ],
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // <-- Añadido
          plugins: { legend: { position: 'top' } }
        }
      });
    }

    // --- Gráfico 3: Flujo de Dinero (Línea) ---
    function crearGraficoFlujo(movimientos) {
      const movs = [...movimientos].reverse(); 
      const labels = movs.map(m => new Date(m.fecha).toLocaleDateString('es-ES'));
      const dataIngresos = movs.map(m => m.tipo === 'ingreso' ? m.cantidad : 0);
      const dataGastos = movs.map(m => m.tipo === 'gasto' ? m.cantidad : 0);

      const ctx = document.getElementById('grafico-flujo').getContext('2d');
      if (chartFlujo) chartFlujo.destroy();

      chartFlujo = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Ingresos',
              data: dataIngresos,
              borderColor: 'green',
              backgroundColor: 'rgba(0, 255, 0, 0.1)',
              fill: true,
              tension: 0.1
            },
            {
              label: 'Gastos',
              data: dataGastos,
              borderColor: 'red',
              backgroundColor: 'rgba(255, 0, 0, 0.1)',
              fill: true,
              tension: 0.1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, // <-- Añadido
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>